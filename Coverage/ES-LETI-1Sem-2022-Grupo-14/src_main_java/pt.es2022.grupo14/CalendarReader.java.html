<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>CalendarReader.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Main (2) (02/11/2022 13:16:31)</a> &gt; <a href="../../index.html" class="el_group">ES-LETI-1Sem-2022-Grupo-14</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">pt.es2022.grupo14</a> &gt; <span class="el_source">CalendarReader.java</span></div><h1>CalendarReader.java</h1><pre class="source lang-java linenums">package pt.es2022.grupo14;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.FileAttribute;
import java.util.Scanner;

import java.util.TreeMap;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;

import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;

<span class="fc" id="L21">public class CalendarReader {</span>

<span class="fc" id="L23">	String webcalRegex = &quot;webcal://fenix\\.iscte-iul\\.pt/publico/publicPersonICalendar\\.do\\?method=iCalendar&amp;username=&quot; +</span>
			&quot;\\p{Lower}{5}&quot; + &quot;@iscte\\.pt&amp;password=&quot; + &quot;\\p{Alnum}+&quot;;
<span class="fc" id="L25">	Pattern webcalCheck = Pattern.compile(webcalRegex);</span>

	public void read(String webcal) {

<span class="pc bpc" id="L29" title="1 of 2 branches missed.">		if (webcal.isBlank()) throw new IllegalArgumentException();</span>

<span class="fc bfc" id="L31" title="All 2 branches covered.">		if (!webcalCheck.matcher(webcal).find()) throw new IllegalArgumentException();</span>

//		webcal://fenix.iscte-iul.pt/publico/publicPersonICalendar.do?method=iCalendar&amp;username=aefcs@iscte.pt&amp;password=v4m2d3fKKnQprqri84bKwiACNzkvW0wgeuKC1yBN1zqoMmqGrfX1eVVLZ1ZrAdkTJ7D9oaJ5ymumul522r7ItOQxTgOVhlhr7DhQyxmkHM7K7RoVqiaMlevpoLUwS6tI
//		webcal://fenix.iscte-iul.pt/publico/publicPersonICalendar.do?method=iCalendar&amp;username=rdlpo@iscte.pt&amp;password=YK69wQ5t4QT3bNCfs7ufNpAyUdaLkVzY8j2EHptfXtckXwGG2odZxl3fylYWZ7oFIZBuWjVfZ9ZYbOt8mmtjhu5cpKgEbGfZIQg2xZU4N5iq5FRbfGvEkVeUStqvOZ82
//		webcal://fenix.iscte-iul.pt/publico/publicPersonICalendar.do?method=iCalendar&amp;username=racjs@iscte.pt&amp;password=bxhMVmPYnfTT17Zo3OyArS5GH3FNlOFj5I4phrZYrfwXTfoUE6N8POymWoRFBljJrK6XdnajVKiUw2P9BaiPMLNU0oDacMLENSI8USO1TIZUEPfbZ3JpCZQKhUAyJXhS

<span class="fc" id="L37">		String user = webcal.split(&quot;username=&quot;)[1];</span>
<span class="fc" id="L38">		user = user.split(&quot;@&quot;)[0];</span>

<span class="fc" id="L40">		String date = null;</span>

<span class="fc" id="L42">		String dateStart = null;</span>
<span class="fc" id="L43">		String dataStart = null;</span>
<span class="fc" id="L44">		String horaStart = null;</span>

<span class="fc" id="L46">		String dateEnd = null;</span>
<span class="fc" id="L47">		String dataEnd = null;</span>
<span class="fc" id="L48">		String horaEnd = null;</span>

<span class="fc" id="L50">		String summary = null;</span>

<span class="fc" id="L52">		JSONConverter jc = new JSONConverter();</span>
		
		try {

<span class="fc" id="L56">			webcal = webcal.replace(&quot;webcal&quot;, &quot;https&quot;);</span>
<span class="fc" id="L57">			URL url = new URL(webcal);</span>
<span class="fc" id="L58">			Path webcalPath = Paths.get(Utils.WEBCAL);</span>
<span class="fc" id="L59">			Path calendarFolder = Paths.get(Utils.CALENDARS);</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">			if (!Files.exists(calendarFolder))</span>
<span class="fc" id="L61">				Files.createDirectory(calendarFolder);</span>
<span class="fc" id="L62">			Files.copy(url.openStream(), webcalPath, REPLACE_EXISTING);</span>

<span class="fc" id="L64">			Scanner scanner = new Scanner(new File(webcalPath.toUri()));</span>

<span class="fc" id="L66">			Map&lt;String, List&lt;String&gt;&gt; eventos = new TreeMap&lt;&gt;();</span>
			
<span class="fc" id="L68">			jc.createFile(user);</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">			while (scanner.hasNextLine()) {</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">				if (scanner.nextLine().equals(&quot;BEGIN:VEVENT&quot;)) {</span>

<span class="fc" id="L74">					date = scanner.nextLine(); // nao usado</span>
<span class="fc" id="L75">					dateStart = scanner.nextLine().split(&quot;:&quot;)[1];</span>
<span class="fc" id="L76">					dataStart = dateStart.split(&quot;T&quot;)[0];</span>
<span class="fc" id="L77">					horaStart = dateStart.split(&quot;T&quot;)[1];</span>
<span class="fc" id="L78">					horaStart = horaStart.split(&quot;Z&quot;)[0];</span>

<span class="fc" id="L80">					dateEnd = scanner.nextLine().split(&quot;:&quot;)[1];</span>
<span class="fc" id="L81">					dataEnd = dateEnd.split(&quot;T&quot;)[0];</span>
<span class="fc" id="L82">					horaEnd = dateEnd.split(&quot;T&quot;)[1];</span>
<span class="fc" id="L83">					horaEnd = horaEnd.split(&quot;Z&quot;)[0];</span>

<span class="fc" id="L85">					summary = scanner.nextLine();</span>

<span class="fc" id="L87">					String atualString = scanner.nextLine();</span>

<span class="fc bfc" id="L89" title="All 2 branches covered.">					if (!atualString.contains(&quot;UID:&quot;)) {</span>
<span class="fc" id="L90">						summary += atualString;</span>
					}

<span class="fc" id="L93">					summary = summary.split(&quot; - &quot;)[0]; //Nome em tuga</span>

<span class="fc bfc" id="L95" title="All 4 branches covered.">					if (summary.contains(&quot;Teste:&quot;) || summary.contains(&quot;Exame:&quot;)</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">							|| summary.contains(&quot;Avaliação Contínua:&quot;)) {</span>
<span class="fc" id="L97">						summary = summary.split(&quot;:&quot;)[2] + &quot; - Exame&quot;;</span>
<span class="fc" id="L98">						summary = summary.strip();</span>
						
<span class="fc" id="L100">					} else {</span>
<span class="fc" id="L101">						summary = summary.split(&quot;:&quot;)[1];</span>
					}

<span class="fc bfc" id="L104" title="All 2 branches covered.">					if (!eventos.containsKey(summary)) {</span>
<span class="fc" id="L105">						eventos.put(summary, new ArrayList&lt;String&gt;());</span>
<span class="fc" id="L106">						eventos.get(summary).add(dataStart + horaStart + &quot; &quot; + dataEnd + horaEnd);</span>

<span class="fc" id="L108">					} else {</span>
<span class="fc" id="L109">						eventos.get(summary).add(dataStart + horaStart + &quot; &quot; + dataEnd + horaEnd);</span>
<span class="fc" id="L110">						Collections.sort(eventos.get(summary));</span>
					}
				}
			}
			
<span class="fc" id="L115">			scanner.close();</span>

<span class="fc" id="L117">			Files.deleteIfExists(webcalPath);</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">			for (String cadeira : eventos.keySet()) {</span>

<span class="fc bfc" id="L121" title="All 2 branches covered.">				for (String horarios : eventos.get(cadeira)) {</span>
<span class="fc" id="L122">					jc.insert(user, cadeira, horarios.split(&quot; &quot;)[0], horarios.split(&quot; &quot;)[1]);</span>
				}
			}
			
<span class="fc" id="L126">			jc.closeFile(user);</span>
			
<span class="pc" id="L128">		} catch (IOException e) {</span>
<span class="nc" id="L129">			e.printStackTrace();</span>
		}
<span class="fc" id="L131">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span>Main (2) (02/11/2022 13:16:31)</div></body></html>